<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trail EPH 計算器 (MVP)</title>
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon.png" />
  <link rel="apple-touch-icon" href="icon.png" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--border:#1e293b;--muted:#94a3b8}
    body{background:var(--bg);color:#e5e7eb;font-family:ui-sans-serif,system-ui,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif}
    .container{max-width:72rem;margin:0 auto;padding:0 1rem}
    .grid{display:grid;gap:16px}
    .grid-2{display:grid;gap:12px;grid-template-columns:1fr}
    .grid-3{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:980px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:repeat(3,1fr)}}
    .stack{display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    .tabnum{font-feature-settings:"tnum";font-variant-numeric:tabular-nums}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .hint{color:var(--muted);font-size:12px}
    .err{color:#ef4444;font-size:12px;margin-top:6px;min-height:1.1em}
    .actions{display:flex;gap:10px;margin-top:10px}
    .ghost{background:transparent;border:1px solid #334155;border-radius:10px;padding:8px 12px}
    .btn{border:1px solid #334155;background:#0b1220;border-radius:10px;padding:8px 12px}
    .btn:hover{background:#0f172a}
    .btn-primary{border-color:#38bdf8;background:#0ea5e91a;color:#7dd3fc}
    .btn-primary:hover{background:#0ea5e933}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid #2b3648;border-radius:999px;padding:2px 10px;font-size:12px;white-space:nowrap}
    .risk-low{color:#10b981;border-color:#10b98133;background:#10b9811a}
    .risk-mid{color:#f59e0b;border-color:#f59e0b33;background:#f59e0b1a}
    .risk-high{color:#ef4444;border-color:#ef444433;background:#ef44441a}
    .delta-badge{margin-left:8px}
    .delta-pos{color:#10b981;border-color:#10b98155;background:#10b9811a}
    .delta-neg{color:#f43f5e;border-color:#f43f5e55;background:#f43f5e1a}
    .delta-zero{color:#cbd5e1;border-color:#475569;background:#334155}
    .numbers{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px}
    .numbers>div{border:1px solid #233044;background:#0d1526;border-radius:12px;padding:10px;display:flex;flex-direction:column}
    .numbers span{color:var(--muted);font-size:12px}
    .numbers strong{font-size:24px}
    .steps summary{cursor:pointer}
    .copy-row{display:flex;gap:8px;margin-top:6px}
    .small-muted{font-size:12px;color:#a8b5c7}

    /* ===== 摘要列 ===== */
    .summary-bar{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,#0b1220 0%,#0f172a 100%);border-bottom:1px solid var(--border)}
    .summary{display:grid;gap:12px;padding:12px 10px;grid-template-columns:1fr}
    @media(min-width:980px){.summary{grid-template-columns:20% 1fr 20%}}
    .sum-box{border:1px solid #233044;background:#0b1220;border-radius:14px;padding:10px 12px;display:flex;align-items:center;gap:14px}
    .sum-label{color:var(--muted);font-size:12px}
    .sum-value{font-weight:800;font-size:28px}
    .sum-unit{color:#94a3b8;font-size:12px;margin-left:6px}
    .seg{display:inline-flex;border:1px solid var(--border);border-radius:12px;padding:2px;background:#0f172a}
    .seg button{padding:6px 10px;border-radius:10px;border:0;background:transparent;color:#cbd5e1}
    .seg button.active{background:#0b1220;color:#fff}
    .sum-mid{display:flex;gap:12px;align-items:center}
    .sum-cta{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .summary-time{min-width:220px;border:1px solid #233044;background:#0d1526;border-radius:12px;padding:8px 10px}
    .summary-time .sum-value{font-size:28px}
  </style>
</head>
<body>
  <header class="container">
    <h1>Trail EPH 計算器（MVP）</h1>
    <p class="hint">一般友善 EP/EPH × 進階校準（R<sub>loss</sub>）｜訓練與賽事換算</p>
  </header>

  <!-- ===== 頂部摘要列（單一時間 + Segmented） ===== -->
  <div class="summary-bar" aria-live="polite">
    <div class="container summary">
      <!-- 左：我的訓練 EPH（顯示目前模式） -->
      <div class="sum-box">
        <div>
          <div class="sum-label">我的訓練 EPH <span id="summaryMode" class="sum-unit"></span>
            <span class="sum-unit" title="EP：距離 + 爬升/100（＋下降/Rloss）；EPH：每小時等效公里（ekm/h）。">ⓘ</span>
          </div>
          <div class="tabnum sum-value" id="summaryEPH">—</div>
        </div>
      </div>

      <!-- 中：預估完賽 + Segmented 切換（一般｜進階） -->
      <div class="sum-box" style="justify-content:space-between">
        <div class="sum-mid">
          <div class="seg" role="radiogroup" aria-label="切換預估模式">
            <button id="segNovice" class="active" role="radio" aria-checked="true" aria-label="一般">一般</button>
            <button id="segCal" role="radio" aria-checked="false" aria-label="進階">進階</button>
          </div>
          <div class="summary-time">
            <div class="sum-label">預估完賽時間</div>
            <div class="tabnum sum-value" id="summaryTime">—</div>
            <div class="badge" id="summaryVerdict">—</div>
          </div>
        </div>
      </div>

      <!-- 右：訓練量風險晶片 + CTA -->
      <div class="sum-box sum-cta">
        <span id="summaryRisk" class="badge" title="訓練量風險（評估依據：單次最長 × 近 4 週平均）">訓練量風險：—</span>
        <button id="summaryRecalc" class="btn btn-primary" accesskey="r" aria-label="重新計算（Alt+R）">重新計算</button>
        <button id="summaryShare" class="btn" aria-label="匯出分享圖">分享</button>
      </div>
    </div>
  </div>

  <main class="container grid" style="grid-template-columns:1fr;gap:16px">
    <div class="grid" style="grid-template-columns:1fr;gap:16px">
      <!-- ===== 輸入你的訓練 ===== -->
      <section class="card" aria-labelledby="inputTitle">
        <h2 id="inputTitle">輸入你的訓練</h2>
        <p class="hint">填寫<strong>這次訓練</strong>的距離、爬升、（可選）下降與時間；下方會算出 EPH。</p>

        <div class="grid-2">
          <label><div>距離 (km)</div><input id="dist" type="number" min="0" step="0.01" placeholder="例如 8.33"></label>
          <label><div>爬升 (m)</div><input id="gain" type="number" min="0" step="1" placeholder="例如 536"></label>
          <label>
            <div>下降 (m，選填)</div>
            <input id="descent" type="number" min="0" step="1" placeholder="例如 520">
            <div class="hint">若要在「進階」計算納入下坡成本，請提供。</div>
          </label>
          <label>
            <div>移動時間 (hh:mm:ss)</div>
            <input id="time" type="text" inputmode="numeric" placeholder="例如 01:15:00" aria-describedby="timeErr">
            <div id="timeErr" class="err"></div>
          </label>
        </div>

        <details>
          <summary>進階：校準／偏好 <span id="advPreset" class="hint">（Rloss：preset）</span></summary>
          <div class="grid-2" style="margin-top:8px">
            <label>
              <div>R<sub>loss</sub> 預設</div>
              <input id="rloss" type="number" min="50" max="1000" step="1" placeholder="例如 250">
              <div class="small-muted">
                <span title="如何估算 Rloss？">ⓘ</span> 建議 150–400。Rloss 代表「每 1 ekm 下降等效多少公尺」，數值越小代表下坡越耗時。
                <br>估算方法：記錄一段長下坡的實跑配速與時間占比，與平路配速比較，反推下降造成的等效距離差，得到 Rloss。
              </div>
            </label>
            <label><div>平路參考配速<br><span class="mono">P<sub>flat</sub>（分/公里）</span></div><input id="pflat" type="text" placeholder="例如 05:30"></label>
          </div>
          <div class="grid-3" style="margin-top:8px">
            <label>
              <div>下坡時間占比 p<sub>down</sub>（%）</div>
              <input id="pdown" type="number" min="0" max="100" step="0.1" placeholder="例如 28" aria-describedby="pdownErr">
              <div id="pdownErr" class="err"></div>
              <div class="hint">建議 10–60 %</div>
            </label>
            <label><div>下坡平均配速 P<sub>down</sub>（分/公里，選填）</div><input id="pdownpace" type="text" placeholder="例如 04:15"></label>
            <label>
              <div>下坡平均坡度 g<sub>down</sub>（%｜無配速可估）</div>
              <input id="gdown" type="number" min="0" max="60" step="0.5" placeholder="例如 10" aria-describedby="gdownErr">
              <div id="gdownErr" class="err"></div>
              <div class="hint">建議 3–20 %</div>
            </label>
          </div>
        </details>

        <div class="actions">
          <button id="calcBtn" class="btn">計算</button>
          <button id="resetBtn" class="ghost">重設</button>
        </div>
      </section>

      <!-- ===== 結果對比（一般 vs 進階） ===== -->
      <section class="card">
        <h2 style="display:flex;align-items:center;gap:8px">
          結果對比
          <span id="diffBadge" class="badge delta-zero" title="進階版與一般版計算差異；正值代表進階更快，負值代表更慢。">+0.0%</span>
        </h2>
        <p class="hint">計算 EP／EPH；進階版會考慮下降成本。<span title="EP：距離 + 爬升/100（＋下降/Rloss）；EPH：每小時等效公里 ekm/h">ⓘ 定義</span></p>

        <div class="grid-2">
          <div class="card" style="padding:12px">
            <h3>一般</h3>
            <div class="numbers">
              <div><span>EP</span><strong class="tabnum" id="basicEP">—</strong><small> ekm</small></div>
              <div><span>EPH</span><strong class="tabnum" id="basicEPH">—</strong><small> ekm/h</small></div>
              <div><span>配速</span><strong class="tabnum" id="basicEPace">—</strong><small> 分/ekm</small></div>
            </div>
            <details class="steps">
              <summary>步驟</summary>
              <pre id="basicSteps">—</pre>
              <div class="copy-row">
                <button class="btn ghost" id="copyBasicSteps">複製公式</button>
                <button class="btn" id="copyBasicVals">複製結果</button>
              </div>
            </details>
          </div>

          <div class="card" style="padding:12px">
            <h3>進階</h3>
            <div class="numbers">
              <div><span>EP<sub>cal</sub></span><strong class="tabnum" id="calEP">—</strong><small> ekm</small></div>
              <div><span>EPH<sub>cal</sub></span><strong class="tabnum" id="calEPH">—</strong><small> ekm/h</small></div>
              <div><span>配速</span><strong class="tabnum" id="calEPace">—</strong><small> 分/ekm</small></div>
            </div>
            <div class="hint" id="calMeta">R<sub>loss</sub>（使用中）＝—</div>
            <details class="steps">
              <summary>步驟</summary>
              <pre id="calSteps">—</pre>
              <div class="copy-row">
                <button class="btn ghost" id="copyCalSteps">複製公式</button>
                <button class="btn" id="copyCalVals">複製結果</button>
              </div>
            </details>
          </div>
        </div>
        <div id="diffLine" class="hint" style="margin-top:6px">—</div>

        <div class="actions">
          <button id="shareBtn" class="btn">匯出分享圖（PNG，透明）</button>
          <a id="downloadLink" class="ghost" style="display:none"></a>
        </div>
        <canvas id="shareCanvas" width="1000" height="420" style="display:none"></canvas>
      </section>
    </div>

    <!-- ===== 右欄：關門換算 + 完賽預估 ===== -->
    <div class="stack">
      <section class="card">
        <h2 style="display:flex;align-items:center;gap:8px">關門時間換算
          <span id="planCalLabel" class="badge">使用中：preset</span>
        </h2>
        <p class="hint">輸入目標賽事與關門時間；再填你的「訓練段」，換算這段訓練所需時間。安全緩衝會把訓練時間再加保守比例。</p>

        <div id="planEmpty" class="card" style="padding:12px;margin-bottom:8px">
          <strong>尚未計算</strong>
          <ul class="hint" style="margin:6px 0 0 18px;list-style:disc;">
            <li>何時使用？先知道賽事的距離／爬升／關門，用來規劃一段訓練需要跑多久。</li>
            <li>需要哪些輸入？賽事距離 (km)、爬升 (m)、關門時間 (hh:mm:ss)、你的訓練段距離與爬升。</li>
            <li>進階：Rloss、平路配速 P<sub>flat</sub>、下坡占比 p<sub>down</sub>、坡度 g<sub>down</sub> 可提升準確度。</li>
          </ul>
        </div>

        <div class="grid-3">
          <label><div>賽事距離 (km)</div><input id="raceD" type="number" min="0" step="0.01" placeholder="例如 30"></label>
          <label><div>賽事爬升 (m)</div><input id="raceG" type="number" min="0" step="1" placeholder="例如 1800"></label>
          <label><div>賽事下降 (m，選填)</div><input id="raceDes" type="number" min="0" step="1" placeholder="例如 1800"></label>

          <label><div>關門時間 (hh:mm:ss)</div>
            <input id="raceCutoff" type="text" inputmode="numeric" placeholder="例如 06:00:00" aria-describedby="raceCutoffErr">
            <div id="raceCutoffErr" class="err"></div>
          </label>
          <label><div>訓練段距離 (km)</div><input id="trainD" type="number" min="0" step="0.01" placeholder="例如 5"></label>
          <label><div>訓練段爬升 (m)</div><input id="trainG" type="number" min="0" step="1" placeholder="例如 500"></label>
          <label><div>訓練段下降 (m，選填)</div><input id="trainDes" type="number" min="0" step="1" placeholder="例如 0"></label>
          <label>
            <div>安全緩衝 (%)</div>
            <input id="bufferPct" type="number" min="0" max="30" step="1" placeholder="例如 0">
            <div class="hint">建議 0–10；會把訓練時間額外增加保守幅度。</div>
          </label>

          <div class="actions" style="grid-column:1/-1">
            <button id="planBtn" class="btn">計算訓練時間</button>
            <button id="planResetBtn" class="ghost">重設</button>
          </div>
        </div>

        <div class="grid-2" style="margin-top:8px">
          <div class="card" style="padding:12px">
            <h3>一般規劃</h3>
            <div class="numbers">
              <div><span>EPH<sub>race</sub></span><strong class="tabnum" id="raceBasicEPH">—</strong><small> ekm/h</small></div>
              <div><span>訓練時間</span><strong class="tabnum" id="trainBasicTime">—</strong><small> hh:mm:ss</small></div>
            </div>
            <details class="steps"><summary>步驟</summary><pre id="planBasicSteps">—</pre></details>
          </div>
          <div class="card" style="padding:12px">
            <h3>進階規劃</h3>
            <div class="numbers">
              <div><span>EPH<sub>race,cal</sub></span><strong class="tabnum" id="raceCalEPH">—</strong><small> ekm/h</small></div>
              <div><span>訓練時間</span><strong class="tabnum" id="trainCalTime">—</strong><small> hh:mm:ss</small></div>
            </div>
            <details class="steps"><summary>步驟</summary><pre id="planCalSteps">—</pre></details>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>完賽時間預估（用我的訓練 EPH）</h2>
        <p class="hint">已套用耐力衰退；若填「進階」風險檢核，會再做保守調整。</p>

        <div class="grid-2">
          <div class="card" style="padding:12px">
            <h3>一般預估</h3>
            <div class="numbers">
              <div><span>預估完賽時間</span><strong class="tabnum" id="predBasicTime">—</strong><small> hh:mm:ss</small></div>
              <div><span>判斷</span><strong id="predBasicNote">—</strong></div>
            </div>
            <ul id="predBasicNeed" class="hint" style="margin:8px 0 4px 18px;list-style:disc;"></ul>
            <div class="hint" id="predBasicSlowest">—</div>
            <details class="steps"><summary>步驟</summary><pre id="predBasicSteps">—</pre></details>
          </div>

          <div class="card" style="padding:12px">
            <h3>進階預估</h3>
            <div class="numbers">
              <div><span>預估完賽時間</span><strong class="tabnum" id="predCalTime">—</strong><small> hh:mm:ss</small></div>
              <div><span>判斷</span><strong id="predCalNote">—</strong></div>
            </div>
            <ul id="predCalNeed" class="hint" style="margin:8px 0 4px 18px;list-style:disc;"></ul>
            <div class="hint" id="predCalSlowest">—</div>
            <details style="margin-top:8px">
              <summary>進階：訓練量風險檢核（可選）</summary>
              <p class="hint" style="line-height:1.9;margin-bottom:10px">填你最近訓練的「單次最長」與「近 4 週平均」。若不足，預估時間會再保守一些。</p>
              <div class="grid-3">
                <label><div>單次最長距離 (km)</div><input id="maxLongD" type="number" min="0" step="0.1" placeholder="例如 24"></label>
                <label><div>單次最長爬升 (m)</div><input id="maxLongG" type="number" min="0" step="1" placeholder="例如 1200"></label>
                <label><div>單次最長時間 (hh:mm:ss)</div><input id="maxLongTime" type="text" inputmode="numeric" placeholder="例如 03:30:00" aria-describedby="maxTimeErr"><div id="maxTimeErr" class="err"></div></label>
                <label><div>近 4 週平均距離 (km/週)</div><input id="wkAvgD" type="number" min="0" step="0.1" placeholder="例如 42"></label>
                <label><div>近 4 週平均爬升 (m/週)</div><input id="wkAvgG" type="number" min="0" step="1" placeholder="例如 1800"></label>
              </div>
              <ul id="riskList" class="hint" style="margin-top:10px"></ul>
            </details>
          </div>
        </div>
      </section>
    </div>
  </main>

  <section class="container card">
    <h2>歷史紀錄（僅本機）</h2>
    <div class="actions">
      <button id="clearHistoryBtn" class="ghost">清除歷史</button>
    </div>
    <div id="historyList" class="hint" style="margin-top:10px"></div>
    <p class="hint">說明：歷史僅存於你的瀏覽器（localStorage），不會上傳。</p>
  </section>

  <footer class="container">
    <p class="hint">© 2025 Trail EPH · 計算以你輸入為準，請善用「步驟」檢視公式。</p>
  </footer>

  <script src="main.js"></script>
</body>
</html>
